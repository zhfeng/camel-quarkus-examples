== Start MS SQL Server

[source, shell]
----
docker run -e "ACCEPT_EULA=Y" -e "MSSQL_SA_PASSWORD=Admin@1234" -p 1433:1433  mcr.microsoft.com/mssql/server:2019-latest
----

== Enable XA Support and create audit_log table for testing

First you need to find the running container id by `docker ps | grep mssql`.

[source, shell]
----
docker exec -it <container id> /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P Admin@123
----

And exec the following

[source, shell]
----
1> EXEC sp_sqljdbc_xa_install
2> CREATE TABLE audit_log ( id bigint NOT NULL IDENTITY(1,1) PRIMARY KEY, message varchar(255) DEFAULT NULL )
3> GO
1>
----

More information https://learn.microsoft.com/en-us/sql/connect/jdbc/understanding-xa-transactions

== Build jta-jpa examples

[source, shell]
----
cd jta-jpa
mvn clean package
----

== Start a application

[source, shell]
----
java -jar target/quarkus-app/quarkus-run.jar
----

== Test Commit and Rollback

[source, shell]
----
curl -X POST http://localhost:8080/api/messages/hello

curl -X POST http://localhost:8080/api/messages/fail

curl http://localhost:8080/api/messages
----

All of them should work

== Test crash recovery

[source, shell]
----
curl -X POST http://localhost:8080/api/messages/crash
----

You should see someting like `curl: (52) Empty reply from server`, and re-start the application `java -jar target/quarkus-app/quarkus-run.jar`. And it will recovery the transaction to add `crash` recorder into the database.

You can check with

[source, shell]
----
curl http://localhost:8080/api/messages
----

You may get the result something like

[source, shell]
----
[{message=hello}, {message=crash}]
----
